Easemob.im.config={xmppURL:"im-api.easemob.com",apiURL:"http://a1.easemob.com",appkey:"ehand#ehand",https:false,multiResources:true};Date.prototype.ToFormat=function(a){var c={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};if(/(y+)/.test(a)){a=a.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))}for(var b in c){if(new RegExp("("+b+")").test(a)){a=a.replace(RegExp.$1,(RegExp.$1.length==1)?(c[b]):(("00"+c[b]).substr((""+c[b]).length)))}}return a};var layim={easemob:{}};layim.easemob.conn=new Easemob.im.Connection({multiResources:Easemob.im.config.multiResources,https:Easemob.im.config.https,url:Easemob.im.config.xmppURL});layim.easemob.conn.init({https:Easemob.im.config.https,url:Easemob.im.config.xmppURL,onOpened:function(){if(layim.easemob.conn.isOpened()){layim.easemob.conn.heartBeat(layim.easemob.conn)}layim.easemob.xxim.online();layim.easemob.conn.setPresence();layim.easemob.conn.getRoster({success:function(a){layim.easemob.xxim.showuser(a)}})},onClosed:function(){layim.easemob.xxim.offline()},onTextMessage:function(a){if(a.ext&&a.ext.time){a.time=a.ext.time}layim.easemob.xxim.showhistory(a)},onEmotionMessage:function(b){if(b.ext&&b.ext.time){b.time=b.ext.time}var a="";$(b.data).each(function(c,d){if(d.type="emotion"){a+='<img src="'+d.data+'" />'}else{if(d.type="txt"){a+=d.data}}});b.data=a;layim.easemob.xxim.showhistory(b)},onPictureMessage:function(a){if(a.ext&&a.ext.time){a.time=a.ext.time}a.data='<a href="'+a.url+'" target="_blank"><img src="'+a.url+'" /></a>';layim.easemob.xxim.showhistory(a)},onAudioMessage:function(a){},onLocationMessage:function(a){},onFileMessage:function(a){},onVideoMessage:function(a){},onPresence:function(a){layim.easemob.xxim.showpresence(a)},onRoster:function(a){layim.easemob.conn.getRoster({success:function(b){layim.easemob.xxim.showuser(b)}})},onInviteMessage:function(a){},onError:function(a){layim.easemob.conn.curError=a},onSendReceiptsMessage:function(a){return false},onCmdMessage:function(b){if(b.ext&&b.ext.time){b.time=b.ext.time}for(var a in b.ext){var c=b.ext[a];if(a=="orderno"){b.action=b.action.replace("[orderno]",'[<a href="/Shop/Order/Info?bllno='+c+'" class="color-main" target="_blank">'+c+"</a>]")}else{if(a=="refundno"){b.action=b.action.replace("[refundno]",'[<a href="/Shop/Order/Refund?bllno='+b.ext.orderno+'" class="color-main" target="_blank">'+c+"</a>]")}else{if(a=="returnno"){b.action=b.action.replace("[returnno]",'[<a href="/Shop/Order/Return?bllno='+b.ext.orderno+"&bcd="+b.ext.bcd+'" class="color-main" target="_blank">'+c+"</a>]")}else{if(a=="sendno"){b.action=b.action.replace("[sendno]",'[<a href="/Shop/Order/Send?bllno='+b.ext.orderno+"&bcd="+b.ext.bcd+'" class="color-main" target="_blank">'+c+"</a>]")}}}}}b.data=b.action;layim.easemob.xxim.showhistory(b)}});layim.easemob.conn.login=function(a,b){layim.easemob.conn.open({apiUrl:Easemob.im.config.apiURL,user:a,pwd:b,appKey:Easemob.im.config.appkey});layim.easemob.conn.lastuser=a;layim.easemob.conn.lastpwd=b;layim.easemob.conn.stopInterval();layim.easemob.conn.myInterval=window.setInterval(function(){if(!layim.easemob.conn.isOpened()&&!layim.easemob.conn.isOpening()){layim.easemob.xxim.rconnect()}},2000)};layim.easemob.conn.logout=function(){layim.easemob.conn.stopHeartBeat(layim.easemob.conn);layim.easemob.conn.close()};layim.easemob.conn.stopInterval=function(){if(layim.easemob.conn.myInterval){window.clearInterval(layim.easemob.conn.myInterval);layim.easemob.conn.myInterval=null}};layim.easemob.init=function(h,d,e,c,b){Easemob.im.config.appkey=d;layim.easemob.conn.login(h,e);var a={msgurl:"mailbox.html?msg=",chatlogurl:"mailbox.html?user=",aniTime:200,right:-230,api:{friend:"js/plugins/layer/layim/data/friend.json",group:"js/plugins/layer/layim/data/group.json",chatlog:"js/plugins/layer/layim/data/chatlog.json",groups:"js/plugins/layer/layim/data/groups.json",sendurl:""},user:{name:c,face:b},autoReplay:["您好，我现在有事不在，一会再和您联系。","你没发错吧？","洗澡中，请勿打扰，偷窥请购票，个体四十，团体八折，订票电话：一般人我不告诉他！","你好，我是主人的美女秘书，有什么事就跟我说吧，等他回来我会转告他的。","我正在拉磨，没法招呼您，因为我们家毛驴去动物保护协会把我告了，说我剥夺它休产假的权利。","<（@￣︶￣@）>","你要和我说话？你真的要和我说话？你确定自己想说吗？你一定非说不可吗？那你说吧，这是自动回复。","主人正在开机自检，键盘鼠标看好机会出去凉快去了，我是他的电冰箱，我打字比较慢，你慢慢说，别急……","(*^__^*) 嘻嘻，是贤心吗？"],chating:{},chatmsg:{},chatuser:{},presences:[],hosts:(function(){var i=location.href.match(/\:\d+/);i=i?i[0]:"";return"http://"+document.domain+i+"/"})(),json:function(j,k,l,i){return $.ajax({type:"POST",url:j,data:k,dataType:"json",success:l,error:i})},stopMP:function(i){i?i.stopPropagation():i.cancelBubble=true}},g=[$(window),$(document),$("html"),$("body")],f={};layim.easemob.xxim=f;f.rconnect=function(){f.node.rconnect.html("").addClass("loading");layim.easemob.conn.login(h,e)};f.offline=function(){f.node.onlinetex.html("离线");f.node.online.addClass("xxim_offline");f.node.rconnect.removeClass("loading").html("重连");f.node.layimMin.parent().addClass("xxim_bottom_offline");if(f.layimNode.attr("state")!="1"){f.expend()}if(f.chatbox){f.chatbox.find(".layim_close").click()}if(f.presencebox){layer.close(f.presencebox.parent().parent().attr("times"))}f.node.list.find(".xxim_chatlist").html("");a.chatmsg={};a.presences=[];f.showcount()};f.online=function(){f.node.onlinetex.html("在线");f.node.online.removeClass("xxim_offline");f.node.list.removeClass("loading");f.node.layimMin.parent().removeClass("xxim_bottom_offline");f.gochat()};f.tabs=function(i){var j=f.node;j.tabs.eq(i).addClass("xxim_tabnow").siblings().removeClass("xxim_tabnow");j.list.eq(i).show().siblings(".xxim_list").hide();if(j.list.eq(i).find("li").length===0){}};f.renode=function(){var i=f.node={tabs:$("#xxim_tabs>span"),list:$(".xxim_list"),online:$(".xxim_online"),setonline:$(".xxim_setonline"),onlinetex:$("#xxim_onlinetex"),xximon:$("#xxim_on"),layimFooter:$("#xxim_bottom"),xximHide:$("#xxim_hide"),xximSearch:$("#xxim_searchkey"),searchMian:$("#xxim_searchmain"),closeSearch:$("#xxim_closesearch"),layimMin:$("#xxim_mymsg"),rconnect:$("#xxim_rconnect")}};f.expend=function(){if(layim.easemob.noexpend){return}var i=f.node;if(f.layimNode.attr("state")!=="1"){f.layimNode.stop().animate({right:a.right},a.aniTime,function(){i.xximon.addClass("xxim_off");try{localStorage.layimState=1}catch(j){}f.layimNode.attr({state:1});i.xximHide.addClass("xxim_show")});i.layimFooter.addClass("xxim_expend").stop().animate({marginLeft:a.right},a.aniTime)}else{f.layimNode.stop().animate({right:0},a.aniTime,function(){i.xximon.removeClass("xxim_off");try{localStorage.layimState=2}catch(j){}f.layimNode.removeAttr("state");i.layimFooter.removeClass("xxim_expend");i.xximHide.removeClass("xxim_show")});i.layimFooter.stop().animate({marginLeft:0},a.aniTime)}};f.layinit=function(){if(!layim.easemob.noexpend){var i=f.node;f.layimNode.attr({state:1}).css({right:a.right});i.xximon.addClass("xxim_off");i.layimFooter.addClass("xxim_expend").css({marginLeft:a.right});i.xximHide.addClass("xxim_show")}f.tabs(2)};f.getobjecturl=function(j){var i=null;if(window.createObjectURL!=undefined){i=window.createObjectURL(j)}else{if(window.URL!=undefined){i=window.URL.createObjectURL(j)}else{if(window.webkitURL!=undefined){i=window.webkitURL.createObjectURL(j)}}}return i};f.popchat=function(k){var j=f.node,i={};i.success=function(l){f.chatbox=l.find("#layim_chatbox");i.chatlist=f.chatbox.find(".layim_chatmore>ul");i.chatlist.html('<li data-id="'+k.id+'" type="'+k.type+'"  id="layim_user'+k.type+k.id+'"><span>'+k.name+"</span><em>×</em></li>");f.tabchat(k,f.chatbox);f.chatbox.find(".layer_setmin").on("click",function(){l.hide();j.layimMin.parent().removeClass("xxim_bottom_3");f.ischating=false});f.chatbox.find(".layim_close").on("click",function(){layer.close(l.attr("times"));f.chatbox=null;a.chating={};a.chatings=0;f.ischating=false});var m=f.chatbox.find(".layim_addimage");if(!Easemob.im.Helper.isCanUploadFileAsync){m.hide()}m.on("click",function(){if(!a.imageinput){a.imageinput=$('<input type="file" id="layim_imageinput" style="display:none;"/>');$(document.body).append(a.imageinput);a.imageinput.on("change",function(){var o=Easemob.im.Helper.getFileUrl("layim_imageinput");if(!o.url){return common.msg("请先选择图片！")}if(["jpg","gif","png","bmp"].indexOf(o.filetype)<0){return common.msg("不支持此图片类型"+o.filetype+"！")}var q=common.load();var p=f.gettime();var n={type:"chat",fileInputId:"layim_imageinput",filename:o.filename,to:f.nowchat.id,apiUrl:Easemob.im.config.apiURL,onFileUploadError:function(r){layer.close(q);common.msg("发送图片失败！")},onFileUploadComplete:function(t){console.log(t);layer.close(q);var s=document.getElementById("layim_imageinput");var r=f.getobjecturl(s.files[0]);f.showmsg({id:f.nowchat.id,type:f.nowchat.type,time:p,name:a.user.name,face:a.user.face,content:'<a href="'+t.uri+"/"+t.entities[0].uuid+'" target="_blank"><img src="'+r+'" /></a>'},"me")},ext:{time:p}};layim.easemob.conn.sendPicture(n)})}a.imageinput.click()});f.chatbox.find(".layim_addface").on("click",function(){var n="transparent";if(navigator.appName=="Microsoft Internet Explorer"&&navigator.appVersion.split(";")[1].replace(/[ ]/g,"")=="MSIE9.0"){n="#ddd"}var t=parseFloat(l.css("top"));var s=parseFloat(l.css("left"));if(!a.facehtml){var p='<ul class="layim_face_list">';var q=Easemob.im.EMOTIONS.map;var r=Easemob.im.EMOTIONS.path;for(var o in q){var u=r+q[o];p+='<li class="layim_face_item" data-face="'+o+'" data-src="'+u+'"><img src="'+u+'"/></li>'}p+="</ul>";a.facehtml=p}layer.open({type:1,title:false,skin:"layui-layerim-face",closeBtn:false,shift:0,move:false,shade:[0.1,n],shadeClose:true,offset:[(t+356)+"px",s+"px"],area:["432px","135px"],border:false,content:a.facehtml,success:function(v){v.on("click",".layim_face_item",function(){layer.close(v.attr("times"));var w=$(this).attr("data-face");var x=f.gettime();var y=$(this).attr("data-src");layim.easemob.conn.sendTextMessage({to:f.nowchat.id,msg:w,type:"chat",ext:{time:x}});f.showmsg({id:f.nowchat.id,type:f.nowchat.type,time:x,name:a.user.name,face:a.user.face,content:'<img src="'+y+'" />'},"me")})}})});i.chatlist.on("mouseenter","li",function(){$(this).find("em").show()}).on("mouseleave","li",function(){$(this).find("em").hide()});i.chatlist.on("click","li em",function(s){var q=$(this).parent(),o=q.attr("type");var n=q.attr("data-id"),p=q.index();var r=i.chatlist.find("li"),t;a.stopMP(s);delete a.chating[o+n];a.chatings--;q.remove();$("#layim_area"+o+n).remove();if(o==="group"){$("#layim_group"+o+n).remove()}if(q.hasClass("layim_chatnow")){if(p===a.chatings){t=p-1}else{t=p+1}f.tabchat(a.chating[r.eq(t).attr("type")+r.eq(t).attr("data-id")])}if(i.chatlist.find("li").length===1){i.chatlist.parent().hide()}});i.chatlist.on("click","li",function(){var p=$(this),o=p.attr("type"),n=p.attr("data-id");f.tabchat(a.chating[o+n])});i.sendType=$("#layim_sendtype"),i.sendTypes=i.sendType.find("span");$("#layim_enter").on("click",function(n){a.stopMP(n);i.sendType.show()});i.sendTypes.on("click",function(){i.sendTypes.find("i").removeClass("fa-check");$(this).find("i").addClass("fa-check")});f.transmit()};i.html='<div class="layim_chatbox" id="layim_chatbox"><h6><span class="layim_move"></span>    <a href="javascript:layim.easemob.xxim.showuserinfo(layim.easemob.xxim.nowchat.id);" class="layim_face" target="_blank"><img src="'+k.face+'" ></a>    <a href="javascript:layim.easemob.xxim.showuserinfo(layim.easemob.xxim.nowchat.id);" class="layim_names" target="_blank">'+k.name+'</a>    <span class="layim_rightbtn">        <i class="layer_setmin">—</i>        <i class="layim_close">&times;</i>    </span></h6><div class="layim_chatmore" id="layim_chatmore">    <ul class="layim_chatlist"></ul></div><div class="layim_groups" id="layim_groups"></div><div class="layim_chat">    <div class="layim_chatarea" id="layim_chatarea">        <ul class="layim_chatview layim_chatthis"  id="layim_area'+k.type+k.id+'"></ul>    </div>    <div class="layim_tool">        <i class="layim_addface fa fa-meh-o" title="发送表情"></i>        <i class="layim_addimage fa fa-picture-o" title="上传图片"></i>    </div>    <textarea class="layim_write" id="layim_write"></textarea>    <div class="layim_send">        <div class="layim_sendbtn" id="layim_sendbtn">发送<span class="layim_enter" id="layim_enter"><em class="layim_zero"></em></span></div>        <div class="layim_sendtype" id="layim_sendtype">            <span><i class="fa fa-check"></i>按Enter键发送</span>            <span><i class="fa"></i>按Ctrl+Enter键发送</span>        </div>    </div></div></div>';if(a.chatings<1){layer.open({type:1,border:[0],title:false,shade:false,skin:"layui-layerim",area:["620px","492px"],move:".layim_chatbox .layim_move",moveType:1,closeBtn:false,zIndex:layer.zIndex,offset:[(($(window).height()-493)/2)+"px",""],content:i.html,success:function(l){i.success(l)}})}else{i.chatmore=f.chatbox.find("#layim_chatmore");i.chatarea=f.chatbox.find("#layim_chatarea");i.chatmore.show();i.chatmore.find("ul>li").removeClass("layim_chatnow");i.chatmore.find("ul").append('<li data-id="'+k.id+'" type="'+k.type+'" id="layim_user'+k.type+k.id+'" class="layim_chatnow"><span>'+k.name+"</span><em>×</em></li>");i.chatarea.find(".layim_chatview").removeClass("layim_chatthis");i.chatarea.append('<ul class="layim_chatview layim_chatthis" id="layim_area'+k.type+k.id+'"></ul>');f.tabchat(k)}i.chatgroup=f.chatbox.find("#layim_groups");if(k.type==="group"){i.chatgroup.find("ul").removeClass("layim_groupthis");i.chatgroup.append('<ul class="layim_groupthis" id="layim_group'+k.type+k.id+'"></ul>');f.getGroups(k)}i.chatgroup.on("click","ul>li",function(){f.popchatbox($(this))})};f.settop=function(i){layer.zIndex++;i.css("z-index",layer.zIndex)};f.showuserinfo=function(m){var l=$("#layim_chatbox_info_"+m);if(l.length){return f.settop(l.parent().parent())}var j=f.node,i={};var k=$.extend({from:m},f.getinfo(m,function(o,n){f.setuserinfo(o,n)}));i.success=function(n){f.setuserinfo(m,$.extend({from:m},f.getinfo(m)));n.find(".layim_close").on("click",function(){layer.close(n.attr("times"))});n.find(".layim_chatinfo_chatuser").on("click",function(){f.inchat($.extend({from:m},f.getinfo(m)));if(f.chatbox){f.settop(f.chatbox.parent().parent())}});n.find(".layim_chatinfo_adduser").on("click",function(){layer.confirm('<input class="layui-layer-text" type="text" placeholder="验证信息" />',{title:"添加好友",btn:["确定","取消"],zIndex:layer.zIndex,skin:"layui-layerim-dialog",shade:false,moveType:1},function(o,p){var q=p.find(".layui-layer-text").val();layim.easemob.conn.subscribe({to:m,message:q});layer.msg("请求发送成功！",{zIndex:layer.zIndex})})});n.find(".layim_chatinfo_deleteuser").on("click",function(){layer.confirm("是否删除好友？",{btn:["删除","取消"],zIndex:layer.zIndex,skin:"layui-layerim-dialog",shade:false,moveType:1},function(){layim.easemob.conn.removeRoster({to:m,success:function(){layer.msg("删除成功！",{zIndex:layer.zIndex});layim.easemob.conn.unsubscribed({to:m})}})})})};i.html='<div class="layim_chatbox layim_chatbox_info" id="layim_chatbox_info_'+m+'"><h6><span class="layim_move"></span>    <a href="javascript:void(0);" class="layim_face" target="_blank"><img class="layim_chatinfo_face" src="'+k.face+'" ></a>    <div class="layim_rightinfos">        <div><span class="layim_chatinfo_name">'+k.name+'</span><i class="fa fa-user layim_chatinfo_sex" style="color:#4CAE4C;line-height:1.33em;margin-left:5px;display:none;"></i></div>        <div>用户号：<span class="layim_chatinfo_id">'+m+'</span></div>        <div>积分：<span class="layim_chatinfo_intg">'+(k.intg||0)+'</span></div>    </div>    <span class="layim_rightbtn">        <i class="layim_close">&times;</i>    </span></h6><div class="layim_chatinfo">    <div>电话号码：<span class="layim_chatinfo_phone">'+(k.phone||"")+'</span></div>    <div>地&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;区：<span class="layim_chatinfo_city">'+(k.province||"")+(k.city||"")+(k.district||"")+'</span></div></div><div class="layim_chatinfo_bottom">    <div class="layim_chatinfo_btn layim_chatinfo_chatuser">发送消息</div>    <div class="layim_chatinfo_btn layim_chatinfo_adduser">添加好友</div>    <div class="layim_chatinfo_btn layim_chatinfo_deleteuser" style="display:none;">删除好友</div></div></div>';layer.open({type:1,border:[0],title:false,shade:false,skin:"layui-layerim",area:["300px","492px"],move:".layim_chatbox .layim_move",zIndex:layer.zIndex,moveType:1,closeBtn:false,offset:[(($(window).height()-493)/2)+"px",""],content:i.html,success:function(n){i.success(n)}})};f.getuserinfo=function(j){var i=null;$(f.userlist).each(function(k,l){if(l.subscription=="both"||l.subscription=="to"){if(l.name==j){i=l}}});return i};f.setuserinfo=function(l,j){var k=$("#layim_chatbox_info_"+l);if(!k.length){return}k.find(".layim_chatinfo_name").html(j.name);k.find(".layim_chatinfo_face").attr("src",j.face);var i=k.find(".layim_chatinfo_sex").hide();if(j.sex=="M"){i.css("color","#4CAE4C").show()}if(j.sex=="F"){i.css("color","#FF808E").show()}k.find(".layim_chatinfo_intg").html(j.intg||0);k.find(".layim_chatinfo_phone").html(j.phone||"");k.find(".layim_chatinfo_city").html((j.Province||"")+(j.city||"")+(j.district||""));if(f.getuserinfo(l)){k.find(".layim_chatinfo_deleteuser").show().siblings(".layim_chatinfo_adduser").hide()}else{k.find(".layim_chatinfo_deleteuser").hide().siblings(".layim_chatinfo_adduser").show()}};f.setinfo=function(i){var j={name:i.MbrName,face:i.MbrPhoto,sex:i.Sex,intg:i.UseIntg,phone:i.Phone,province:i.Province,city:i.City,district:i.District};a.chatuser[i.MbrID]=j;return j};f.tabchat=function(l){var k=f.node,i={},j=l.type+l.id;f.nowchat=l;f.chatbox.find("#layim_user"+j).addClass("layim_chatnow").siblings().removeClass("layim_chatnow");f.chatbox.find("#layim_area"+j).addClass("layim_chatthis").siblings().removeClass("layim_chatthis");f.chatbox.find("#layim_group"+j).addClass("layim_groupthis").siblings().removeClass("layim_groupthis");f.chatbox.find(".layim_face>img").attr("src",l.face).attr("class","layim_chatface_"+l.id);f.chatbox.find(".layim_names").text(l.name).attr("class","layim_names layim_chatname_"+l.id);i.groups=f.chatbox.find(".layim_groups");if(l.type==="group"){i.groups.show()}else{i.groups.hide()}$("#layim_write").focus();f.showusermsg(l.id,l.type);f.ischating=true;f.showcount(l.id)};f.getinfo=function(k,i){var j=a.chatuser[k];if(j){return j}else{if(k=="admin"){j={name:"物品在线助手",face:"/Files/Common/logo_80x80.png"};a.chatuser[k]=j;return j}j={name:k,face:"/Files/Shop/mbr-photo-default.png"};a.chatuser[k]=j;common.post("/Api/Shop/ShopMbrBLL/GetMbrChatInfo",{MbrID:k},function(l){var m=f.setinfo(l.ResponseContent);if(f.node&&f.node.list){f.node.list.find(".layim_chatname_"+k).html(m.name);f.node.list.find(".layim_chatface_"+k).attr("src",m.face)}if(f.chatbox){f.chatbox.find(".layim_chatname_"+k).html(m.name);f.chatbox.find(".layim_chatface_"+k).attr("src",m.face)}if(f.presencebox){f.presencebox.find(".layim_chatname_"+k).html(m.name);f.presencebox.find(".layim_chatface_"+k).attr("src",m.face)}if(i){i(k,m)}},null,{autologin:false,mask:false});return j}};f.showusermsg=function(j,i){$(a.chatmsg[j]).each(function(k,l){f.showmsg($.extend({time:l.time,name:l.from,face:a.user.face,content:l.data,type:i,id:j},f.getinfo(j)));layim.easemob.conn.sendReceiptsMessage({id:l.id})});a.chatmsg[j]=[]};f.showmsg=function(n,j){var k=n.type+n.id;var i='<li class="'+(j==="me"?"layim_chateme":"")+'"><div class="layim_chatuser">'+function(){if(j==="me"){return'<img src="'+n.face+'" >'}else{return'<img src="'+n.face+'" class="layim_chatface_'+n.id+'">'}}()+'</div><div class="layim_chatsay">'+n.content+'<em class="layim_zero"></em></div></li>';var l=f.chatbox.find("#layim_area"+k);var m=n.time?n.time.substring(0,16):"";if(l[0].lasttime!=m){l[0].lasttime=m;l.append('<div class="layim_chatarea_time"><span>'+m+"</span></div>")}l.append(i);l.scrollTop(l[0].scrollHeight)};f.popchatbox=function(m){var l=f.node,j=m.attr("data-id"),n={id:j,type:m.attr("type"),name:m.find(".xxim_onename").text(),face:m.find(".xxim_oneface").attr("src"),href:"profile.html?user="+j},k=n.type+j;if(!a.chating[k]){f.popchat(n);a.chatings++}else{f.tabchat(n)}a.chating[k]=n;var i=$("#layim_chatbox");if(i[0]){l.layimMin.parent().addClass("xxim_bottom_3");i.parents(".layui-layerim").show()}};f.setpresence=function(l){if(!f.presencebox){return}var i="layim_presencebox_item_"+l.from;var j=f.presencebox.find("#"+i);if(j.length){j.remove()}var m=$.extend({from:l.from},f.getinfo(l.from));var k='<div class="layim_presencebox_item" id="'+i+'"><div class="layim_presencebox_item_left" onclick="layim.easemob.xxim.showuserinfo(\''+m.from+'\')"><img class="layim_chatface_'+m.from+'" src="'+m.face+'"><div class="layim_chatname_'+m.from+'">'+m.name+"</div><div>"+(l.status||"申请加为好友")+'</div></div><div class="layim_presencebox_item_right"><div class="layim_presencebox_accept_btn" onclick="layim.easemob.xxim.presenceaccept(\''+m.from+'\')">接受</div><div class="layim_presencebox_reject_btn" onclick="layim.easemob.xxim.presencereject(\''+m.from+"')\">拒绝</div></div></div>";f.presencebox.find(".layim_presencebox_content").append(k)};f.presenceaccept=function(i){$("#layim_presencebox_item_"+i+" .layim_presencebox_item_right").html("已接受");layim.easemob.conn.subscribed({to:i,message:"[resp:true]"});layim.easemob.conn.subscribe({to:i,message:"[resp:true]"})};f.presencereject=function(i){$("#layim_presencebox_item_"+i+" .layim_presencebox_item_right").html("已拒绝");layim.easemob.conn.unsubscribed({to:i})};f.poppresencebox=function(){if(f.presencebox){return f.settop(f.presencebox.parent().parent())}var i={};i.success=function(j){f.presencebox=j.find("#layim_presencebox");f.presencebox.find(".layim_presencebox_search_keyword").on("keyup",function(k){if(k.which==13){f.searchuser()}});$(a.presences).each(function(k,l){f.setpresence(l)});a.presences=[];f.showcount()};i.html='<div class="layim_presencebox" id="layim_presencebox">    <div class="layim_presencebox_search">        <input class="layui-layer-text layim_presencebox_search_keyword" type="text" placeholder="昵称/手机号/邮箱" />        <div class="layim_presencebox_search_btn" onclick="layim.easemob.xxim.searchuser()">查找</div>    </div>    <div class="layim_presencebox_content">    </div></div>';layer.open({type:1,title:"新的联系人",shade:false,moveType:1,skin:"layui-layerim",area:["600px","400px"],zIndex:layer.zIndex,offset:[(($(window).height()-400)/2)+"px",""],content:i.html,cancel:function(j){f.presencebox=null},success:function(j){i.success(j)}})};f.getGroups=function(l){var i=l.type+l.id,k="",j=f.chatbox.find("#layim_group"+i);j.addClass("loading");a.json(a.api.groups,{},function(m){if(m.status===1){var o=0,n=m.data.length;if(n>0){for(;o<n;o++){k+='<li data-id="'+m.data[o].id+'" type="one"><img src="'+m.data[o].face+'" class="xxim_oneface"><span class="xxim_onename">'+m.data[o].name+"</span></li>"}}else{k='<li class="layim_errors">没有群员</li>'}}else{k='<li class="layim_errors">'+m.msg+"</li>"}j.removeClass("loading");j.html(k)},function(){j.removeClass("loading");j.html('<li class="layim_errors">请求异常</li>')})};f.transmit=function(){var j=f.node,i={};j.sendbtn=$("#layim_sendbtn");j.imwrite=$("#layim_write");i.send=function(){var k={content:j.imwrite.val(),id:f.nowchat.id,sign_key:"",_:+new Date};if(k.content.replace(/\s/g,"")===""){layer.tips("说点啥呗！","#layim_write",2);j.imwrite.focus()}else{var l=f.gettime();layim.easemob.conn.sendTextMessage({to:k.id,msg:k.content,type:"chat",ext:{time:l}});f.showmsg({id:k.id,type:f.nowchat.type,time:l,name:a.user.name,face:a.user.face,content:k.content},"me");j.imwrite.val("").focus()}};j.sendbtn.on("click",i.send);j.imwrite.keyup(function(k){if(k.keyCode===13){i.send()}})};f.event=function(){var i=f.node;i.tabs.eq(0).addClass("xxim_tabnow");i.tabs.on("click",function(){var k=$(this),j=k.index();f.tabs(j)});i.list.on("click","h5",function(){var l=$(this),k=l.siblings(".xxim_chatlist"),j=l.find("i");if(j.hasClass("fa-caret-down")){k.hide();j.attr("class","fa fa-caret-right")}else{k.show();j.attr("class","fa fa-caret-down")}});i.online.on("click",function(j){if(i.layimMin.parent().hasClass("xxim_bottom_offline")){return}f.tabs(2);if(f.layimNode.attr("state")=="1"){f.expend()}});i.xximon.on("click",f.expend);i.xximHide.on("click",f.expend);i.rconnect.on("click",function(){f.rconnect()});i.xximSearch.keyup(function(){var j=$(this).val().replace(/\s/g,"");if(j!==""){i.searchMian.show();i.closeSearch.show();i.list.eq(3).html('<li class="xxim_errormsg">没有符合条件的结果</li>')}else{i.searchMian.hide();i.closeSearch.hide()}});i.closeSearch.on("click",function(){$(this).hide();i.searchMian.hide();i.xximSearch.val("").focus()});a.chatings=0;i.list.on("click",".xxim_childnode",function(){var j=$(this);f.popchatbox(j)});i.list.on("click",".xxim_addnode",function(){f.poppresencebox()});i.layimMin.on("click",function(){$(this).parent().addClass("xxim_bottom_3");$("#layim_chatbox").parents(".layui-layerim").show()});g[1].on("click",function(){i.setonline.hide();$("#layim_sendtype").hide()})};f.gettime=function(){return new Date().ToFormat("yyyy/MM/dd hh:mm:ss")};f.gochat=function(){var k=f.forchat;if(!k){return}$.extend(k,{time:f.gettime()});var l=a.chatmsg[k.from];if(!l){l=a.chatmsg[k.from]=[];var j='<li data-id="'+k.from+'" class="xxim_childnode xxim_childnode_'+k.from+'" type="one"><img src="'+k.face+'" class="xxim_oneface layim_chatface_'+k.from+'"><span class="xxim_onename layim_chatname_'+k.from+'">'+k.name+'</span><em class="xxim_time">'+(k.time?k.time.substring(5,10):"")+'</em><i class="xxim_chatcount xxim_chatcount_'+k.from+'">1</i></li>';f.node.list.eq(2).find(".xxim_chatlist").prepend(j)}var i=f.node.list.find(".xxim_childnode_"+k.from);if(i.length){f.popchatbox(i.eq(0))}f.forchat=null};f.inchat=function(i){f.forchat=i;if(layim.easemob.conn.isOpened()){f.gochat()}else{f.rconnect()}};f.showuser=function(j){f.userlist=j;var i="";i+='<li class="xxim_addnode" id="xxim_addnode"><span class="xxim_addnode_face"><i class="fa fa-user"></i><i class="fa fa-plus-circle"></i></span><span class="">新的联系人</span><i class="xxim_chatcount" style="'+(a.presences.length?"display:block;":"")+'">'+a.presences.length+"</i></li>";$(j).each(function(k,m){if(m.subscription=="both"||m.subscription=="to"){var l=$.extend({from:m.name},f.getinfo(m.name));i+='<li data-id="'+l.from+'" class="xxim_childnode xxim_childnode_'+l.from+'" type="one"><img src="'+l.face+'" class="xxim_oneface layim_chatface_'+l.from+'"><span class="xxim_onename layim_chatname_'+l.from+'">'+l.name+'</span><i class="xxim_chatcount xxim_chatcount_'+l.from+'"></i></li>'}});f.node.list.eq(0).find(".xxim_chatlist").html(i)};f.searchuser=function(){if(!f.presencebox){return}var i=f.presencebox.find(".layim_presencebox_search_keyword").val();if(!i){return}common.post("/Api/Shop/ShopMbrBLL/GetMbrChatInfo",{KeyWord:i},function(j){if(!j.ResponseContent){return layer.msg("用户不存在！",{zIndex:layer.zIndex})}f.setinfo(j.ResponseContent);f.showuserinfo(j.ResponseContent.MbrID)})};f.showpresence=function(i){if(i.type==="subscribe"){if(i.status){if(i.status.indexOf("resp:true")>-1){layim.easemob.conn.subscribed({to:i.from,message:"[resp:true]"});return}}if(!f.presencebox){a.presences.push(i);f.showcount()}else{f.setpresence(i)}}if(i.type==="subscribed"){}if(i.type==="unsubscribe"||i.type==="unsubscribed"){layim.easemob.conn.removeRoster({to:i.from,groups:["default"],success:function(){layim.easemob.conn.unsubscribed({to:i.from})}})}};f.showhistory=function(j){$.extend(j,f.getinfo(j.from));var k=a.chatmsg[j.from];if(!k){k=a.chatmsg[j.from]=[j];var i='<li data-id="'+j.from+'" class="xxim_childnode xxim_childnode_'+j.from+'" type="one"><img src="'+j.face+'" class="xxim_oneface layim_chatface_'+j.from+'"><span class="xxim_onename layim_chatname_'+j.from+'">'+j.name+'</span><em class="xxim_time">'+(j.time?j.time.substring(5,10):"")+'</em><i class="xxim_chatcount xxim_chatcount_'+j.from+'"></i></li>';f.node.list.eq(2).find(".xxim_chatlist").prepend(i)}else{k.push(j)}if(f.ischating&&f.nowchat&&f.nowchat.id==j.from){f.showusermsg(j.from,"one")}f.showcount(j.from)};f.showcount=function(p){if(p){var o=a.chatmsg[p];if(!o){return}var j=f.node.list.find(".xxim_chatcount_"+p);if(o.length){j.html(o.length).show()}else{j.hide().html(o.length)}}var n=a.presences?a.presences.length:0;if(n){f.node.list.find("#xxim_addnode .xxim_chatcount").html(n).show()}else{f.node.list.find("#xxim_addnode .xxim_chatcount").html(n).hide()}var m=n;for(var l in a.chatmsg){m+=a.chatmsg[l].length}var k=f.node.online.children(".xxim_chatcount");if(layim.easemob.showtip){layim.easemob.showtip(m)}else{if(m){k.html(m)}else{k.html("")}}};f.view=(function(){var i=f.layimNode=$('<div id="xximmm" class="xxim_main"><div class="xxim_top" id="xxim_top">  <div class="xxim_search"><i class="fa fa-search"></i><input id="xxim_searchkey" /><span id="xxim_closesearch">×</span></div>  <div class="xxim_tabs" id="xxim_tabs"><span class="xxim_tabfriend" title="好友"><i class="fa fa-user"></i></span><span class="xxim_tabgroup" title="群组"><i class="fa fa-users"></i></span><span class="xxim_latechat"  title="最近聊天"><i class="fa fa-clock-o"></i></span></div>  <ul class="xxim_list loading"><li class="xxim_liston"><ul class="xxim_chatlist"></ul></li></ul>  <ul class="xxim_list loading"></ul>  <ul class="xxim_list loading"><li class="xxim_liston"><ul class="xxim_chatlist"></ul></li></ul>  <ul class="xxim_list xxim_searchmain" id="xxim_searchmain"></ul></div><ul class="xxim_bottom xxim_bottom_3 xxim_bottom_offline" id="xxim_bottom"><li class="xxim_online xxim_offline" id="xxim_online" title="状态"><i class="xxim_chatcount"></i><span id="xxim_onlinetex">离线</span></li><li class="xxim_mymsg" id="xxim_mymsg" title="对话窗口"><i class="fa fa-comments"></i></li><li class="xxim_seter" id="xxim_seter" title="设置"><i class="fa fa-gear"></i><div></div></li><li class="xxim_rconnect loading" id="xxim_rconnect"></li><li class="xxim_hide" id="xxim_hide" title="显示/隐藏面板"><i class="fa fa-exchange"></i></li></ul></div>');g[3].append(i);f.renode();f.event();f.layinit()}())};